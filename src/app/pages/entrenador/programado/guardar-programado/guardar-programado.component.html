<div class="row" *ngIf="cargando">
    <div class="col-sm-12">
        <div class="alert alert-dismissible bg-info text-center ">
            <strong class="text-light">Cargando</strong>
            <br>
            <i class="fas fa-refresh fa-spin fa-2x" aria-hidden="true"></i>
            <br>
            <span class="text-light">Espere por favor</span>
        </div>
    </div>
</div>

<div class="row" *ngIf="!cargando">
    <div class="col-6">
        <div class="card mb-5 mb-xl-8 shadow-sm card-flush">
            <div class="border-0 pt-5 m-5">

                <div class="row align-items-center">

                    <div class="col-4">
                        <!--begin::Input group-->
                        <div class="mb-2">
                            <!--begin::Label-->
                            <label class="d-flex align-items-center fs-6 fw-bold mb-2">
                                <span class="required">Grados</span>
                            </label>
                            <!--end::Label-->
                            <select class="form-select " data-placeholder="Seleccione" data-control="select2"
                                data-hide-search="false" name="componente_id" [(ngModel)]="grado_id"
                                (change)="filtrarPreguntas()" [disabled]="seleccionadas.length > 0">
                                <option [ngValue]="9999999" selected>Grado</option>
                                <option *ngFor="let grado of grados" [value]="grado.id">{{
                                    grado.nombre
                                    }}</option>
                            </select>
                        </div>
                        <!--end::Input group-->
                    </div>

                    <div class="col-8 align-items-center">
                        <!--begin::Label-->
                        <label class="d-flex align-items-center fs-6 fw-bold">
                            <span class="">&nbsp;</span>
                        </label>
                        <!--end::Label-->

                        <!-- <button class="btn btn-primary me-3 " (click)="moverPreguntas()">
                            <i class="fas fa-arrows-alt"></i> Mover
                        </button> -->
                        <button class="btn btn-success" (click)="guardarPreguntas()" placement="top"
                            ngbTooltip="Guardar">
                            <i class="fas fa-check"></i>
                            {{ programado_id === 0 ? 'Guardar' : 'Actualizar' }}
                        </button>

                        <a [routerLink]="['/gestion-programado',materia_id]" class="btn btn-danger ms-2">
                            <!--begin::Svg Icon | path: icons/duotune/arrows/arr075.svg-->
                            <i class="ki-duotone ki-arrow-left">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <!--end::Svg Icon-->
                            Volver
                        </a>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <h3 class="align-items-start flex-column">
                            <div class="d-flex align-items-center position-relative my-1">
                                <!--begin::Svg Icon | path: icons/duotune/general/gen021.svg-->
                                <span class="svg-icon svg-icon-1 position-absolute ms-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none">
                                        <rect opacity="0.5" x="17.0365" y="15.1223" width="8.15546" height="2" rx="1"
                                            transform="rotate(45 17.0365 15.1223)" fill="black" />
                                        <path
                                            d="M11 19C6.55556 19 3 15.4444 3 11C3 6.55556 6.55556 3 11 3C15.4444 3 19 6.55556 19 11C19 15.4444 15.4444 19 11 19ZM11 5C7.53333 5 5 7.53333 5 11C5 14.4667 7.53333 17 11 17C14.4667 17 17 14.4667 17 11C17 7.53333 14.4667 5 11 5Z"
                                            fill="black" />
                                    </svg>
                                </span>
                                <!--end::Svg Icon-->
                                <form action method="GET" autocomplete="off">
                                    <input type="text" name="txtbusqueda" #input
                                        (keydown.enter)="buscarPregunta( input.value )" id="txtbusqueda" value
                                        class="form-control form-control-solid w-500px ps-14 me-3"
                                        placeholder="Enter para buscar Preguntas" [(ngModel)]="terminoBusqueda"
                                        (change)="buscarPregunta( input.value )" />
                                </form>
                                <button (click)="buscarPregunta( input.value )" class="btn btn-success btn-icon"
                                    title="buscar" placement="top" ngbTooltip="Buscar">
                                    <i class="fas fa-search fs-4 "></i>
                                </button>
                            </div>
                        </h3>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <!--begin::Input group-->
                        <div class="mb-2">
                            <!--begin::Label-->
                            <label class="d-flex align-items-center fs-6 fw-bold mb-2">
                                <span class="required">Componente</span>
                            </label>
                            <!--end::Label-->
                            <select class="form-select " data-placeholder="Seleccione" data-control="select2"
                                data-hide-search="false" name="componente_id" [(ngModel)]="componente_id"
                                (change)="filtrarPreguntas()">
                                <option [ngValue]="9999999" selected>Componente</option>
                                <option *ngFor="let componente of componentes" [value]="componente.id">{{
                                    componente.nombre
                                    }}</option>
                            </select>
                        </div>
                        <!--end::Input group-->
                    </div>

                    <div class="col-6">
                        <!--begin::Input group-->
                        <div class="mb-2">
                            <!--begin::Label-->
                            <label class="d-flex align-items-center fs-6 fw-bold mb-2">
                                <span class="required">Competencias</span>
                            </label>
                            <!--end::Label-->
                            <select class="form-select " data-placeholder="Seleccione" data-control="select2"
                                data-hide-search="false" name="competencia_id" [(ngModel)]="competencia_id"
                                (change)="filtrarPreguntas()">
                                <option [ngValue]="9999999" selected>Competencia</option>
                                <option *ngFor="let competencia of competencias" [value]="competencia.id">{{
                                    competencia.nombre
                                    }}</option>
                            </select>
                        </div>
                        <!--end::Input group-->
                    </div>
                </div>

                <div *ngIf="seleccionadas.length > 0" class="text-warning mt-2">
                    <small>
                        <i class="fas fa-exclamation-circle"></i>
                        No puedes cambiar el grado mientras tengas preguntas seleccionadas.
                    </small>
                </div>
            </div>
            <div class="card-body pb-0">
                <h3 class="card-title pb-0">Preguntas registradas
                    (<small>{{ totalRegistros }}</small>) para {{ materia?.test_name }}</h3>
                <div class="card-px pt-1 pb-0">
                    <div class="table-responsive">
                        <!-- <table class="table align-middle table-row-dashed "> -->
                        <table style="border-collapse: collapse;"
                            class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">

                            <thead>
                                <!--begin::Table row-->
                                <tr class="text-start text-muted fw-bolder fs-7 text-uppercase gs-0">
                                    <th class="min-w-30px text-center">
                                        <input type="checkbox" [(ngModel)]="seleccionarTodo"
                                            (change)="toggleSeleccionarTodo()" [disabled]="grado_id === 9999999" />
                                    </th>
                                    <th class="min-w-20px text-center">#</th>
                                    <th class="min-w-100px text-start">Pregunta</th>
                                    <th class="min-w-50px text-center">Opción</th>
                                </tr>
                                <!--end::Table row-->
                            </thead>

                            <tbody>
                                <tr style=" line-height: 1;"
                                    *ngFor="let pregunta of preguntasFiltradas | paginate: { itemsPerPage: 10, currentPage: p }; let i=index ">

                                    <td class="text-center">
                                        <input type="checkbox" [checked]="estaSeleccionada(pregunta)"
                                            (change)="toggleSeleccion(pregunta)" [disabled]="grado_id === 9999999" />
                                    </td>

                                    <td style='padding: 4px 8px;white-space: nowrap;font-weight: bold;vertical-align: middle;text-wrap: nowrap;'
                                        class="text-center">
                                        {{ (i+1) }}
                                    </td>

                                    <td class="text-start"
                                        style=" padding: 4px 8px;white-space: nowrap;font-weight: bold; vertical-align: middle;text-wrap: nowrap;">
                                        {{ pregunta.que_desc | slice:0:50 }}{{ pregunta.que_desc.length > 50 ? '...' :
                                        '' }}
                                    </td>
                                    <td class="text-center"
                                        style=" padding: 4px 8px;white-space: nowrap;font-weight: bold; vertical-align: middle;text-wrap: nowrap;">
                                        <a placement="top" ngbTooltip="Ver pregunta" title="Ver pregunta"
                                            (click)="verPregunta(pregunta)" class="btn btn-icon btn-info btn-sm me-1">
                                            <i class="fas fa-eye fs-4 "></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="d-flex justify-content-center">
                            <pagination-controls (pageChange)="onPageChange($event)" previousLabel="Anterior"
                                nextLabel="Siguiente"></pagination-controls>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="col-6">
        <div class="card mb-5 mb-xl-8 shadow-sm card-flush">
            <div class="card-body pb-0">
                <div class="row">
                    <div class="col-12">
                        <div class="mb-3">
                            <label class="form-label">Nombre del entrenamiento programado</label>
                            <input type="text" class="form-control" [(ngModel)]="nombre"
                                placeholder="Ingresa un nombre">
                        </div>
                    </div>
                </div>
                <!-- Contenedor flexible para el título y el botón -->
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h3 class="card-title pb-0 mb-0">Preguntas programadas
                        (<small>{{ seleccionadas.length }}</small>)
                    </h3>

                    <!-- Botón "Eliminar todas" (solo aparece si hay seleccionadas) -->
                    <button *ngIf="seleccionadas.length > 0" class="btn btn-danger" (click)="eliminarTodas()">
                        <i class="fas fa-trash"></i> Eliminar todas
                    </button>
                </div>


                <div class="card-px pt-1 pb-0">
                    <div class="table-responsive">
                        <!-- <table class="table align-middle table-row-dashed "> -->
                        <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3"
                            style="border-collapse: collapse;">

                            <thead>
                                <!--begin::Table row-->
                                <tr class="text-start text-muted fw-bolder fs-7 text-uppercase gs-0">
                                    <th class="min-w-50px text-center">#</th>
                                    <th class="min-w-125px text-start">Pregunta</th>
                                    <th class="min-w-50px text-center">Opciones</th>
                                </tr>
                                <!--end::Table row-->
                            </thead>

                            <tbody>
                                <tr style=" line-height: 1;" *ngFor="let item of seleccionadas; let i=index ">

                                    <td style=' padding: 4px 8px;white-space: nowrap;font-weight: bold;vertical-align: middle;text-wrap: nowrap;'
                                        class="text-center">
                                        {{ (i+1) }}
                                    </td>

                                    <td class="text-start"
                                        style=" padding: 4px 8px;white-space: nowrap;font-weight: bold; vertical-align: middle;text-wrap: nowrap;">
                                        {{ item.que_desc | slice:0:50 }}{{ item.que_desc.length > 50 ? '...' :
                                        '' }}
                                    </td>
                                    <td class="text-center"
                                        style=" padding: 4px 8px;white-space: nowrap;font-weight: bold; vertical-align: middle;text-wrap: nowrap;">

                                        <a placement="top" ngbTooltip="Ver pregunta" title="Ver pregunta"
                                            (click)="verPregunta(item)" class="btn btn-icon btn-info btn-sm me-1">
                                            <i class="fas fa-eye fs-4 "></i>
                                        </a>

                                        <a type="button" class="btn btn-icon btn-danger btn-sm" placement="top"
                                            ngbTooltip="Eliminar" [title]="'Eliminar'" (click)="eliminar(item)">
                                            <i class="fas fs-4 fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>